{% extends 'base.html' %}
(% # coding: utf8 %}

{% block title %}
    Revisión bulto
{% endblock %}

{% block header %}
	<link rel="stylesheet" type="text/css" href="{{ url_for('revision_bultos.static', filename='css/revision_bultos.css') }}">
	<script type="text/javascript">
		$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
		var resp = 0; var titulo = ""; var mens = "";
		function setModalAdvertencia(title, mensaje){
			$("#modalAdvertenciaTitle").text(title);
			$("#modalAdvertenciaMensaje").text(mensaje);
			$("#modalAdvertencia").modal('show');
		};
		function onClickRevisar(){
			if (document.getElementById("InputRevisar").checked == true){
				document.getElementById("InputRevisar").value = 1;
			}else document.getElementById("InputRevisar").value = 0;
		};
		
		function validar_fecha(id,nomb){
			var campo = document.getElementById(id).value;
			var letra = "";
			if (campo.length < 16) {
				setModalAdvertencia("Error al Validar Fecha:","Mensaje: "+nomb+", NO Tiene el Formato Correcto: 'DD-MM-YYYY HH:Mi (24HH/AM-PM)'");
				letra = nomb+": "+campo.length;
			}
			return letra;
		};
		function validar_texto(id,nomb){
			var lista = ['a','A','b','B','c','C','d','D','e','E','f','F','g','G','h','H','i','I','j','J','k','K','l','L',
			'm','M','n','N','o','O','p','P','q','Q','r','R','s','S','t','T','u','U','v','V','w','W','x','X','y','Y','z','Z',
			'1','2','3','4','5','6','7','8','9','0','-','_','(',')','+','=',',',';','.',':','#',' ','\n'];
			var campo = document.getElementById(id).value;
			var letra = "";
			for (x in campo) {
				if(!(lista.indexOf(campo[x]) > -1)){
					setModalAdvertencia("Error al Validar Texto:","Mensaje: "+nomb+", Tiene Caracteres NO Válidos: '"+campo[x]+"'");
					letra = nomb+": "+campo[x];
					break;
				}
			}
			return letra;
		};
		
		function imprimir_boucher(link_boucher){
			titulo = "Éxito "+titulo;
			mens = "Se Abrirá una Nueva Ventana con el Boucher Para Ser Impreso";
			setModalAdvertencia(titulo,"Mensaje: "+mens);
			window.open(link_boucher);
		};
		
		function ReiniciarFormulario(){
			document.getElementById("InputRevisar").value = 0;
			document.getElementById("InputFecha").value = "";
			document.getElementById("InputComentario").value = "";
			document.getElementById("InputSalida").value = "";
			document.getElementById("InputBandeja").value = "";
			document.getElementById("ReadCantidad").value = "";
			document.getElementById("textGlosa").innerHTML= 'Glosa Salida:';
			document.getElementById("InputFecha").readOnly = false;
			document.getElementById("InputComentario").readOnly = false;
			document.getElementById("InputSalida").readOnly = false;
			document.getElementById("InputBandeja").readOnly = true;
			document.getElementById("CamionRobado").disabled = true;
			document.getElementById("TermRevBultos").disabled = true;
		};
		
		function correcto_RegSalida(){
			document.getElementById("InputComentario").value = "";
			document.getElementById("textGlosa").innerHTML = 'Glosa Bandeja:';
			document.getElementById("InputFecha").readOnly = true;
			document.getElementById("InputSalida").readOnly = true;
			document.getElementById("InputBandeja").readOnly = false;
			document.getElementById("CamionRobado").disabled = false;
		};
		
		function correcto_RegBandeja(cant_bandejas){
			document.getElementById("InputBandeja").value = "";
			document.getElementById("textGlosa").innerHTML= 'Glosa Bandeja:';
			document.getElementById("ReadCantidad").value = cant_bandejas;
			document.getElementById("CamionRobado").disabled = true;
			document.getElementById("TermRevBultos").disabled = false;
		};
		
		function correcto_RevBulto(link_boucher){
			titulo = "Al Terminar Revision:";
			imprimir_boucher(link_boucher);
			
			ReiniciarFormulario();
		};
		
		function correcto_AlertaRobo(link_boucher){
			titulo = "Al Alertar Robo:";
			imprimir_boucher(link_boucher);
			
			ReiniciarFormulario();
		};
		
		function ServRevBultos(){
			$.getJSON($SCRIPT_ROOT + '/revisabultos',{
				nro_salida: $("#InputSalida").val(),
				respuesta: resp
			},	function(data){
				console.log(data);
				if(data.cod_status == 0){
					correcto_RevBulto(data.link_boucher);
				}else if(data.cod_status == 1){
					setModalAdvertencia("Error Al Terminar Revision:","Mensaje: "+data.msg_status);
				}else if(data.cod_status == 2){
					if(confirm(data.msg_status)){
						resp = 1;
						setModalAdvertencia("Éxito Al Terminar Revision:","Mensaje: Confirmado");
						console.log($SCRIPT_ROOT);
						ServRevBultos();
					}else{
						resp = 0;
						setModalAdvertencia("Éxito Al Terminar Revision:","Mensaje: Continúe Escaneando");
					}
				}else if(data.cod_status == 3){
					correcto_RevBulto(data.link_boucher);
					setModalAdvertencia("Éxito Al Terminar Revision:","Mensaje: "+data.msg_status);
				}else setModalAdvertencia("Error Al Terminar Revision:","Mensaje: NO HAY DATOS DE VUELTA.");
			});
		};
		
		$(function(){
			$('#modalAdvertencia').modal({ show: false});
			ReiniciarFormulario();
			
			if ({{contexto.cod_status}} == 0){
				$("#InputFecha").focus();
			}else if({{contexto.cod_status}} == 1){
				document.getElementById("InputFecha").readOnly = true;
				document.getElementById("InputSalida").readOnly = true;
				document.getElementById("InputComentario").readOnly = true;
				setModalAdvertencia("Error de Contexto:","Mensaje: {{contexto.msg_status}}\n(SE BLOQUEARÁN TODOS LOS CAMPOS)");
			}else if({{contexto.cod_status}} == 3){
				$("#InputFecha").focus();
				setModalAdvertencia("Éxito de Contexto:","Mensaje: {{contexto.msg_status}}");
			}else {
				document.getElementById("InputFecha").readOnly = true;
				document.getElementById("InputSalida").readOnly = true;
				document.getElementById("InputComentario").readOnly = true;
				setModalAdvertencia("Error de Contexto:","Mensaje: NO HAY DATOS DE VUELTA.\n(SE BLOQUEARÁN TODOS LOS CAMPOS)");
			}
			
			$('#InputSalida').keypress(function(event) {
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if (keycode == 13 & document.getElementById("InputSalida").value.length > 0) {
					var fecha = validar_fecha("InputFecha", "Fecha Llegada");
					var texto = validar_texto("InputComentario", "Glosa Salida");
					if (fecha.length > 0) document.getElementById("InputFecha").value = "";
					else if (texto.length > 0) document.getElementById("InputComentario").value = "";
					else{
						console.log($(this).val());
						console.log($SCRIPT_ROOT);
						$.getJSON($SCRIPT_ROOT + '/registrasalida',{
							nro_salida: $("#InputSalida").val(),
							rev_todo: $("#InputRevisar").val(),
							fch_llegada: $("#InputFecha").val(),
							glosa: $("#InputComentario").val()
						},	function(data){
							console.log(data);
							if(data.cod_status == 0){
								correcto_RegSalida();
							}else if(data.cod_status == 1){
								document.getElementById("InputSalida").value = "";
								setModalAdvertencia("Error Al Registrar Salida:","Mensaje: "+data.msg_status);
							}else if(data.cod_status == 3){
								correcto_RegSalida();
								setModalAdvertencia("Éxito Al Registrar Salida:","Mensaje: "+data.msg_status);
							}else setModalAdvertencia("Error Al Registrar Salida:","Mensaje: NO HAY DATOS DE VUELTA.");
						});
					}
				}
			});
			
			$('#InputBandeja').keypress(function(event) {
				var keycode = (event.keyCode ? event.keyCode : event.which);
				if (keycode == 13 & document.getElementById("InputBandeja").value.length > 0) {
					var texto = validar_texto("InputComentario", "Glosa Bandeja");
					if (texto.length > 0) document.getElementById("InputComentario").value = "";
					else {
						console.log($(this).val());
						console.log($SCRIPT_ROOT);
						$.getJSON($SCRIPT_ROOT + '/registrabandeja',{
							nro_salida: $("#InputSalida").val(),
							nro_bandeja: $("#InputBandeja").val(),
							glosa: $("#InputComentario").val()
						},	function(data){
							console.log(data);
							if(data.cod_status == 0){
								correcto_RegBandeja(data.cant_bandejas);
							}else if(data.cod_status == 1){
								document.getElementById("InputBandeja").value = "";
								setModalAdvertencia("Error Al Registrar Bandeja:","Mensaje: "+data.msg_status);
							}else if(data.cod_status == 3){
								correcto_RegBandeja(data.cant_bandejas);
								setModalAdvertencia("Éxito Al Registrar Bandeja:","Mensaje: "+data.msg_status);
							}else setModalAdvertencia("Error Al Registrar Bandeja:","Mensaje: NO HAY DATOS DE VUELTA.");
						});
					}
				}
			});
			
			$('#CamionRobado').click(function(event) {
				if(confirm('Seguro Que Desea Continuar?')){
					console.log($(this).val());
					console.log($SCRIPT_ROOT);
					$.getJSON($SCRIPT_ROOT + '/camionrobado',{
						nro_salida: $("#InputSalida").val()
					},	function(data){
						console.log(data);
						if(data.cod_status == 0){
							correcto_AlertaRobo(data.link_boucher);
						}else if(data.cod_status == 1){
							setModalAdvertencia("Error Al Alertar Robo:","Mensaje: "+data.msg_status);
						}else if(data.cod_status == 3){
							correcto_AlertaRobo(data.link_boucher);
							setModalAdvertencia("Éxito Al Alertar Robo:","Mensaje: "+data.msg_status);
						}else setModalAdvertencia("Error Al Alertar Robo:","Mensaje: NO HAY DATOS DE VUELTA.");
					});
				}
			});
			
			$('#TermRevBultos').click(function(event) {
				if(confirm('Seguro Que Desea Continuar?')){
					console.log($(this).val());
					console.log($SCRIPT_ROOT);
					ServRevBultos();
				}
			});
			
		});
	</script>
{% endblock %}

{% block screen_name %}
	<h4 class="titulo_pag">Revisión de Bultos</h4>
{% endblock %}

{% block info_contexto %}
	<div class="row">
		<div class="col-3">Empresa:</div>
		<div class="col-9" id="id_Empresa">{{contexto.Empresa}}</div>
		<div class="col-3">Local:</div>
		<div class="col-9" id="id_Local">{{contexto.Local}}</div>
		<div class="col-3">Usuario:</div>
		<div class="col-9" id="id_Usuario">{{contexto.Usuario}}</div>
	</div>
{% endblock %}

{% block field_container %}
	<!-- contenedor de campos -->
	<div class="row" id="baserow">
		<div class="col" id="fieldscol">
			<div class="d-flex align-items-center justify-content-center h-100">
				<div class="col" id="colx">
					<div class="row">
						<div class="col-5">
							<label>Revisar todo:</label>
						</div>
						<div class="col">
							<input type="checkbox" id="InputRevisar" onclick="onClickRevisar()" style="margin-top:10px">
						</div>
					</div>
					<!--<div class="row" style="display:none;">-->
					<div class="row">
						<div class="col-5">
							<label>Fecha Llegada:</label>
						</div>
						<div class="col-7">
							<input type="datetime-local" class="form-control" id="InputFecha" style='font-size:14px;padding:.100rem .45rem'>
						</div>
					</div>
					<div class="row">
						<div class="col-5">
							<label id="textGlosa"></label>
						</div>
						<div class="col-7">
							<textarea rows="2" maxlength='240' class="form-control" id="InputComentario"></textarea>
						</div>
					</div>
					<div class="row">
						<div class="col-5">
							<label>Salida:</label>
						</div>
						<div class="col-7">
							<input type="number" class="form-control" id="InputSalida">
						</div>
					</div>
					<div class="row">
						<div class="col-5">
							<label>Bandeja:</label>
						</div>
						<div class="col-7">
							<input type="number" class="form-control" id="InputBandeja">
						</div>
					</div>
					<div class="row">
						<div class="col-7">
							<label>Contador Bandejas:</label>
						</div>
						<div class="col-5">
							<input type="number" class="form-control" id="ReadCantidad" readonly="">
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div class="row" style="margin-bottom:10px">
		<div class="col">
			<div class="center-block text-center">
				<button class="btn btn-info" style="float: left;" id="CamionRobado">Camión Robado</button>
				<button class="btn btn-info" style="float: right;" id="TermRevBultos">Terminar</button>
			</div>
		</div>
	</div>
{% endblock %}